# Agent Output JSON Schema

This directory contains JSON Schema definitions for GitHub Agentic Workflows.

## agent-output.json

This schema validates the structure of agent output files generated by the `collect_output` step in GitHub Agentic Workflows.

### Structure

The agent output file follows this TypeScript-like structure:

```typescript
type AgentOutput = {
  items: SafeOutput[];
  errors: string[];
};

type SafeOutput = 
  | { type: 'create-issue', title: string, body: string, labels?: string[] }
  | { type: 'add-issue-comment', body: string }
  | { type: 'create-pull-request', title: string, body: string, branch?: string, labels?: string[] }
  | { type: 'add-issue-label', labels: string[] }
  | { type: 'update-issue', status?: 'open' | 'closed', title?: string, body?: string, issue_number?: number | string }
  | { type: 'push-to-branch', message?: string, pull_request_number?: number | string }
  | { type: 'create-pull-request-review-comment', path: string, line: number | string, body: string, start_line?: number | string, side?: 'LEFT' | 'RIGHT' }
  | { type: 'create-discussion', title: string, body: string }
  | { type: 'missing-tool', tool: string, reason: string, alternatives?: string }
  | { type: 'create-security-report', sarif: object | string, category?: string };
```

### Usage

To validate agent output using this schema:

**JavaScript/Node.js with AJV:**
```javascript
import Ajv from 'ajv';
import fs from 'fs';

const ajv = new Ajv();
const schema = JSON.parse(fs.readFileSync('schemas/agent-output.json', 'utf8'));
const validate = ajv.compile(schema);

const agentOutput = {
  items: [
    {
      type: 'create-issue',
      title: 'Bug report',
      body: 'Found an issue...'
    }
  ],
  errors: []
};

if (validate(agentOutput)) {
  console.log('Valid agent output');
} else {
  console.log('Validation errors:', validate.errors);
}
```

**Python with jsonschema:**
```python
import json
import jsonschema

with open('schemas/agent-output.json', 'r') as f:
    schema = json.load(f)

agent_output = {
    "items": [
        {
            "type": "create-issue",
            "title": "Bug report", 
            "body": "Found an issue..."
        }
    ],
    "errors": []
}

try:
    jsonschema.validate(agent_output, schema)
    print("Valid agent output")
except jsonschema.ValidationError as e:
    print(f"Validation error: {e.message}")
```

### Safe Output Types

Each safe output type has specific requirements:

- **create-issue**: Requires `title` and `body`, optional `labels` array
- **add-issue-comment**: Requires `body` 
- **create-pull-request**: Requires `title` and `body`, optional `branch` and `labels`
- **add-issue-label**: Requires `labels` array
- **update-issue**: Requires at least one of `status`, `title`, or `body` (enforced by JavaScript validation)
- **push-to-branch**: Optional `message` and `pull_request_number`
- **create-pull-request-review-comment**: Requires `path`, `line`, and `body`, optional `start_line` and `side`
- **create-discussion**: Requires `title` and `body`
- **missing-tool**: Requires `tool` and `reason`, optional `alternatives`
- **create-security-report**: Requires `sarif` (object or string), optional `category`

### Validation Notes

- The schema provides structural validation only
- Complex business logic validation is handled by the JavaScript code in `pkg/workflow/js/collect_ndjson_output.cjs`
- All string fields are automatically sanitized during processing
- Line numbers can be provided as numbers or numeric strings
- The `sarif` field in security reports accepts both JSON objects and JSON strings

### Schema Version

This schema uses JSON Schema Draft 07 for maximum compatibility with validation libraries.